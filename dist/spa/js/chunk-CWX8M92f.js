import{b3 as X,r as o,j as e,Q as A,s as K,b4 as v,E as _,b5 as Z,aY as W,t as S,b2 as ee,b1 as se,U as ae,aW as te}from"./chunk-BfPIZJcL.js";import{u as ne,a as re,o as le,B as c,C as d,c as m,I as oe,S as ie,j as ce,k as de,l as me,m as f,g as xe,h as he,i as ue,p as ge,q as fe,r as U,s as x,t as je,v as i,b as y,D as pe,w as Ne,x as ye,y as be,z as ve,A as we}from"./chunk-B3_5kBca.js";import{a as z}from"./chunk-Dhk8SyyT.js";import{m as b}from"./chunk-DakqyWim.js";const H={pending:"bg-yellow-100 text-yellow-800 border-yellow-200",confirmed:"bg-green-100 text-green-800 border-green-200",cancelled:"bg-red-100 text-red-800 border-red-200",locked:"bg-blue-100 text-blue-800 border-blue-200"},O={pending:e.jsx(W,{className:"h-3 w-3"}),confirmed:e.jsx(S,{className:"h-3 w-3"}),cancelled:e.jsx(v,{className:"h-3 w-3"}),locked:e.jsx(K,{className:"h-3 w-3"})},M={full:"bg-green-100 text-green-800 border-green-200",partial:"bg-orange-100 text-orange-800 border-orange-200"},q=(r,u)=>r>=u?"full":"partial",j=r=>new Intl.NumberFormat("en-US",{style:"currency",currency:"BDT",minimumFractionDigits:0,maximumFractionDigits:0}).format(r),G=r=>({SA:"Saudi Arabia",AE:"United Arab Emirates",TR:"Turkey",MY:"Malaysia",ID:"Indonesia",KW:"Kuwait",OM:"Oman",BH:"Bahrain",JO:"Jordan",LB:"Lebanon"})[r]||r;function Te(){const{user:r,hasPermission:u}=ne(),[B]=X(),{toast:T}=re(),[l,P]=o.useState([]),[J,E]=o.useState(!0),[I,w]=o.useState(null),[g,V]=o.useState(""),[p,L]=o.useState("all"),[a,Y]=o.useState(null),{networkError:$,clearNetworkError:F,retryWithErrorHandler:Q}=le();o.useEffect(()=>{const s=B.get("status");s&&["pending","confirmed","cancelled","locked"].includes(s)&&L(s)},[B]);const N=async()=>{try{E(!0),w(null),F();const s=await Q(()=>z.getBookings(),2);P(Array.isArray(s)?s:[])}catch(s){console.error("Failed to load bookings:",s);const t=s instanceof Error?s.message:"Failed to load bookings";w(t),P([])}finally{E(!1)}};o.useEffect(()=>{r&&N()},[r]);const R=async(s,t)=>{try{const n=l.find(k=>k.id===s);if(!n)throw new Error("বুকিং খুঁজে পাওয়া যায়নি / Booking not found");const h=n.status;if(!{pending:["confirmed","cancelled"],confirmed:["cancelled"],cancelled:[],expired:[]}[h]?.includes(t))throw new Error(`অবৈধ স্ট্যাটাস পরিবর্তন: ${h} থেকে ${t} এ পরিবর্তন করা যাবে না / Invalid status transition: Cannot change from ${h} to ${t}`);if(t==="confirmed"&&!u("confirm_sales"))throw new Error("বুকিং নিশ্চিত করার অনুমতি নেই / No permission to confirm bookings");if(t==="confirmed"){if(new Date(n.ticketInfo?.flightDate||"")<=new Date)throw new Error("অতীতের ���্লাইটের জন্য বুকিং নিশ্চিত করা যাবে না / Cannot confirm booking for past flights");const D=n.sellingPrice*n.passengerInfo.paxCount;if(D>5e5&&!window.confirm(`বড় পরিমাণের বুকিং নিশ্চিতকরণ: ৳${D.toLocaleString()}

আপনি কি ���িশ্চিত?

Large booking confirmation: ৳${D.toLocaleString()}

Are you sure?`))return}if(t==="cancelled"&&!window.confirm(`বুকিং বাতিল করা হবে: ${n.passengerInfo?.name}

আপনি কি নিশ্চিত?

Cancel booking for: ${n.passengerInfo?.name}

Are you sure?`))return;console.log("=== বুকিং স্ট্যাটাস আ���ডেট অডিট লগ / BOOKING STATUS UPDATE AUDIT LOG ==="),console.log("বুকিং আইডি / Booking ID:",s),console.log("যাত্রীর নাম / Passenger Name:",n.passengerInfo?.name),console.log("পূর্বের স্ট্যাটাস / Previous Status:",h),console.log("নতুন স্ট্যাটাস / New Status:",t),console.log("ব্যবহারকারী / User:",r?.name),console.log("সময় / Time:",new Date().toLocaleString()),console.log("=== লগ শেষ / END LOG ==="),await z.updateBookingStatus(s,t),await N(),T({title:"সফল / Success!",description:`বুকিং স্ট্যাটাস আপডেট হয়েছে: ${h} → ${t} / Booking status updated: ${h} → ${t}`})}catch(n){console.error("Failed to update booking status:",n),T({title:"ত্রুটি / Error",description:n.message||"বুকিং স্ট্���াটাস আপডেট করতে ব্যর্থ / Failed to update booking status",variant:"destructive"})}},C=(Array.isArray(l)?l:[]).filter(s=>{const t=s.passengerInfo?.name?.toLowerCase().includes(g.toLowerCase())||s.agentInfo?.name?.toLowerCase().includes(g.toLowerCase())||s.id?.toLowerCase().includes(g.toLowerCase()),n=p==="all"||s.status===p;return t&&n});if(!r)return e.jsx("div",{children:"Loading..."});if(J)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(A,{className:"h-6 w-6 animate-spin text-primary"}),e.jsx("span",{className:"font-body text-foreground",children:"Loading bookings..."})]})});if(I||$){const s=$||I,t=s?.includes("Failed to fetch")||s?.includes("Network error")||s?.includes("Unable to connect");return e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"mx-auto mb-4 p-3 bg-red-100 rounded-full w-fit",children:t?e.jsx(K,{className:"h-8 w-8 text-red-600"}):e.jsx(v,{className:"h-8 w-8 text-red-600"})}),e.jsx("h3",{className:"text-lg font-heading font-bold text-foreground mb-2",children:t?"Connection Problem":"Error Loading Bookings"}),e.jsx("p",{className:"text-foreground/70 font-body mb-4",children:s}),t&&e.jsxs("div",{className:"text-sm text-muted-foreground mb-6 p-4 bg-muted rounded-lg max-w-md mx-auto",children:[e.jsx("p",{className:"font-medium mb-2",children:"Troubleshooting tips:"}),e.jsxs("ul",{className:"text-left space-y-1",children:[e.jsx("li",{children:"• Check your internet connection"}),e.jsx("li",{children:"• Refresh the page"}),e.jsx("li",{children:"• Try again in a few moments"})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 justify-center",children:[e.jsxs(c,{onClick:()=>{F(),w(null),N()},className:"velvet-button text-primary-foreground font-body",children:[e.jsx(A,{className:"h-4 w-4 mr-2"}),"Try Again"]}),t&&e.jsx(c,{variant:"outline",onClick:()=>window.location.reload(),className:"font-body",children:"Refresh Page"})]})]})}return e.jsxs("div",{className:"space-y-6",children:[e.jsx(b.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.5},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"p-3 bg-gradient-to-br from-luxury-gold to-luxury-bronze rounded-full animate-glow animate-float",children:e.jsx(_,{className:"h-6 w-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-heading font-bold velvet-text",children:"Booking Management"}),e.jsx("p",{className:"text-foreground/70 font-body",children:"Process customer bookings and requests"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(c,{onClick:N,variant:"outline",size:"sm",className:"font-body hover:scale-105 transform transition-all duration-200",children:[e.jsx(A,{className:"h-4 w-4 mr-2"}),"Refresh"]}),e.jsxs(c,{variant:"outline",size:"sm",className:"font-body hover:scale-105 transform transition-all duration-200",children:[e.jsx(Z,{className:"h-4 w-4 mr-2"}),"Export"]})]})]})}),e.jsx(b.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2,duration:.5},children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[{title:"Total Bookings",value:Array.isArray(l)?l.length:0,icon:e.jsx(_,{className:"h-4 w-4 text-white"}),color:"bg-blue-500"},{title:"Pending",value:Array.isArray(l)?l.filter(s=>s.status==="pending").length:0,icon:e.jsx(W,{className:"h-4 w-4 text-white"}),color:"bg-yellow-500"},{title:"Confirmed",value:Array.isArray(l)?l.filter(s=>s.status==="confirmed").length:0,icon:e.jsx(S,{className:"h-4 w-4 text-white"}),color:"bg-green-500"},{title:"Cancelled",value:Array.isArray(l)?l.filter(s=>s.status==="cancelled").length:0,icon:e.jsx(v,{className:"h-4 w-4 text-white"}),color:"bg-red-500"}].map((s,t)=>e.jsx(d,{className:"luxury-card border-0",children:e.jsxs(m,{className:"flex items-center justify-between p-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-foreground/70 font-body",children:s.title}),e.jsx("p",{className:"text-2xl font-bold font-heading velvet-text",children:s.value})]}),e.jsx("div",{className:`p-3 rounded-full ${s.color}`,children:s.icon})]})},s.title))})}),e.jsx(b.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3,duration:.5},children:e.jsx(d,{className:"luxury-card border-0",children:e.jsx(m,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(ee,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-foreground/50 h-4 w-4"}),e.jsx(oe,{placeholder:"Search by passenger name, agent, or booking ID...",value:g,onChange:s=>V(s.target.value),className:"pl-10 font-body"})]})}),e.jsxs(ie,{value:p,onValueChange:L,children:[e.jsxs(ce,{className:"w-full sm:w-48 font-body",children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),e.jsx(de,{placeholder:"Filter by status"})]}),e.jsxs(me,{children:[e.jsx(f,{value:"all",children:"All Status"}),e.jsx(f,{value:"pending",children:"Pending"}),e.jsx(f,{value:"confirmed",children:"Confirmed"}),e.jsx(f,{value:"cancelled",children:"Cancelled"}),e.jsx(f,{value:"locked",children:"Locked"})]})]})]})})})}),e.jsx(b.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4,duration:.5},children:e.jsxs(d,{className:"luxury-card border-0",children:[e.jsxs(xe,{children:[e.jsxs(he,{className:"font-heading velvet-text",children:["Booking Requests (",C.length,")"]}),e.jsx(ue,{className:"font-body",children:"Manage and process customer booking requests"})]}),e.jsx(m,{children:e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs(ge,{children:[e.jsx(fe,{children:e.jsxs(U,{children:[e.jsx(x,{className:"font-heading",children:"Booking ID"}),e.jsx(x,{className:"font-heading",children:"Passenger"}),e.jsx(x,{className:"font-heading",children:"Agent"}),e.jsx(x,{className:"font-heading",children:"Status"}),e.jsx(x,{className:"font-heading",children:"Payment"}),e.jsx(x,{className:"font-heading",children:"Created"}),e.jsx(x,{className:"font-heading",children:"Actions"})]})}),e.jsx(je,{children:C.map(s=>e.jsxs(U,{className:"hover:bg-cream-50/50",children:[e.jsxs(i,{className:"font-mono text-xs",children:[s.id.slice(0,8),"..."]}),e.jsx(i,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(ae,{className:"h-4 w-4 text-foreground/50"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium font-body",children:s.customer_name}),e.jsx("div",{className:"text-xs text-foreground/50 font-body",children:s.passport_number||"N/A"})]})]})}),e.jsxs(i,{children:[e.jsx("div",{className:"font-body",children:s.agent_name}),e.jsx("div",{className:"text-xs text-foreground/50 font-body",children:s.customer_phone})]}),e.jsx(i,{children:e.jsxs(y,{className:`${H[s.status]} flex items-center space-x-1 font-body`,children:[O[s.status],e.jsx("span",{className:"capitalize",children:s.status})]})}),e.jsx(i,{children:e.jsxs("div",{className:"space-y-1",children:[e.jsx(y,{className:`${M[s.amount_paid>=s.total_amount?"full":"partial"]} font-body`,children:s.amount_paid>=s.total_amount?"Full Payment":"Partial Payment"}),e.jsxs("div",{className:"text-xs text-foreground/70 font-body",children:[j(s.amount_paid)," / ",j(s.total_amount)]})]})}),e.jsx(i,{children:e.jsxs("div",{className:"text-sm font-body",children:[e.jsx("div",{children:G(s.country_code)}),e.jsxs("div",{className:"text-xs text-foreground/50",children:[new Date(s.departure_date).toLocaleDateString()," - ",new Date(s.return_date).toLocaleDateString()]})]})}),e.jsx(i,{className:"text-sm text-foreground/70 font-body",children:new Date(s.created_at).toLocaleDateString()}),e.jsx(i,{children:e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs(pe,{children:[e.jsx(Ne,{asChild:!0,children:e.jsx(c,{variant:"ghost",size:"sm",onClick:()=>Y(s),className:"font-body",children:e.jsx(te,{className:"h-4 w-4"})})}),e.jsxs(ye,{className:"max-w-2xl",children:[e.jsxs(be,{children:[e.jsx(ve,{className:"font-heading",children:"Booking Details"}),e.jsx(we,{className:"font-body",children:"Complete booking information and actions"})]}),a&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-heading font-semibold",children:"Passenger Information"}),e.jsxs("div",{className:"text-sm space-y-1 font-body",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Name:"})," ",a.customer_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Passport:"})," ",a.passport_number||"N/A"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Phone:"})," ",a.customer_phone]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",a.customer_email]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-heading font-semibold",children:"Agent Information"}),e.jsxs("div",{className:"text-sm space-y-1 font-body",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Name:"})," ",a.agent_name||"N/A"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Phone:"})," ",a.agent_phone||a.customer_phone||"N/A"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",a.agent_email||a.customer_email||"N/A"]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-heading font-semibold",children:"Booking Details"}),e.jsxs("div",{className:"text-sm space-y-1 font-body",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Booking ID:"})," ",a.id]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Ticket ID:"})," ",a.ticket_id]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Country:"})," ",G(a.country_code)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Ticket Type:"})," ",a.ticket_type]})]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[e.jsx(d,{className:"border-0 bg-muted",children:e.jsxs(m,{className:"p-4",children:[e.jsx("h4",{className:"font-heading font-semibold mb-2",children:"Travel Dates"}),e.jsxs("div",{className:"text-sm space-y-1 font-body",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Departure:"})," ",new Date(a.departure_date).toLocaleDateString()]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Return:"})," ",new Date(a.return_date).toLocaleDateString()]})]})]})}),e.jsx(d,{className:"border-0 bg-muted",children:e.jsxs(m,{className:"p-4",children:[e.jsx("h4",{className:"font-heading font-semibold mb-2",children:"Payment Information"}),e.jsxs("div",{className:"text-sm space-y-1 font-body",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Total Amount:"})," ",j(a.total_amount)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Amount Paid:"})," ",j(a.amount_paid)]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Remaining:"})," ",j(a.total_amount-a.amount_paid)]})]})]})}),e.jsx(d,{className:"border-0 bg-muted",children:e.jsxs(m,{className:"p-4",children:[e.jsx("h4",{className:"font-heading font-semibold mb-2",children:"Status Information"}),e.jsxs("div",{className:"text-sm space-y-1 font-body",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Status:"})," ",e.jsxs(y,{className:`${H[a.status]} flex items-center space-x-1 font-body w-fit`,children:[O[a.status],e.jsx("span",{className:"capitalize",children:a.status})]})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Payment:"})," ",e.jsx(y,{className:`${M[q(a.amount_paid,a.total_amount)]} font-body w-fit`,children:q(a.amount_paid,a.total_amount)==="full"?"Full Payment":"Partial Payment"})]})]})]})})]}),a.notes&&e.jsx(d,{className:"border-0 bg-muted",children:e.jsxs(m,{className:"p-4",children:[e.jsx("h4",{className:"font-heading font-semibold mb-2",children:"Notes"}),e.jsx("p",{className:"text-sm font-body",children:a.notes})]})}),e.jsxs("div",{className:"flex space-x-2",children:[u("confirm_bookings")&&a.status==="pending"&&e.jsxs(c,{onClick:()=>R(a.id,"confirmed"),className:"velvet-button bg-green-600 hover:bg-green-700 font-body",children:[e.jsx(S,{className:"h-4 w-4 mr-2"}),"Confirm Booking"]}),a.status!=="cancelled"&&e.jsxs(c,{onClick:()=>R(a.id,"cancelled"),variant:"destructive",className:"font-body",children:[e.jsx(v,{className:"h-4 w-4 mr-2"}),"Cancel Booking"]})]})]})]})]})})})]},s.id))})]}),C.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(_,{className:"h-12 w-12 text-foreground/30 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-heading font-bold text-green-600 mb-2",children:"Database Clean - Ready for Real Bookings!"}),e.jsx("p",{className:"text-foreground/70 font-body",children:g||p!=="all"?"Try adjusting your search or filter criteria.":"All demo bookings have been removed. New bookings will appear here once tickets are added and booked."})]})]})})]})})]})}export{Te as B};
