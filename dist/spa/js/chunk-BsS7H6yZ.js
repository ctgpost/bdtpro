import{b3 as V,r as o,j as e,Q as v,s as z,b4 as j,E as w,b5 as W,aY as H,t as A,b2 as K,b1 as Q,U as X,aW as Y}from"./chunk-BfPIZJcL.js";import{u as J,a as Z,o as ee,B as l,C,c as k,I as se,S as ae,j as ne,k as te,l as re,m as x,g as oe,h as le,i as ie,p as ce,q as de,r as F,s as i,t as me,v as c,b as R,D as xe,w as he,x as ge,y as fe,z as ue,A as je}from"./chunk-B3_5kBca.js";import{a as U}from"./chunk-Dhk8SyyT.js";import{m as u}from"./chunk-DakqyWim.js";const pe={pending:"bg-yellow-100 text-yellow-800 border-yellow-200",confirmed:"bg-green-100 text-green-800 border-green-200",cancelled:"bg-red-100 text-red-800 border-red-200",locked:"bg-blue-100 text-blue-800 border-blue-200"},Ne={pending:e.jsx(H,{className:"h-3 w-3"}),confirmed:e.jsx(A,{className:"h-3 w-3"}),cancelled:e.jsx(j,{className:"h-3 w-3"}),locked:e.jsx(z,{className:"h-3 w-3"})},ye={full:"bg-green-100 text-green-800 border-green-200",partial:"bg-orange-100 text-orange-800 border-orange-200"};function De(){const{user:h,hasPermission:B}=J(),[D]=V(),{toast:E}=Z(),[r,S]=o.useState([]),[q,T]=o.useState(!0),[P,p]=o.useState(null),[m,O]=o.useState(""),[g,_]=o.useState("all"),[n,G]=o.useState(null),{networkError:L,clearNetworkError:I,retryWithErrorHandler:M}=ee();o.useEffect(()=>{const s=D.get("status");s&&["pending","confirmed","cancelled","locked"].includes(s)&&_(s)},[D]);const f=async()=>{try{T(!0),p(null),I();const s=await M(()=>U.getBookings(),2);S(Array.isArray(s)?s:[])}catch(s){console.error("Failed to load bookings:",s);const a=s instanceof Error?s.message:"Failed to load bookings";p(a),S([])}finally{T(!1)}};o.useEffect(()=>{h&&f()},[h]);const $=async(s,a)=>{try{const t=r.find(y=>y.id===s);if(!t)throw new Error("বুকিং খুঁজে পাওয়া যায়নি / Booking not found");const d=t.status;if(!{pending:["confirmed","cancelled"],confirmed:["cancelled"],cancelled:[],expired:[]}[d]?.includes(a))throw new Error(`অবৈধ স্ট্যাটাস পরিবর্তন: ${d} থেকে ${a} এ পরিবর্তন করা যাবে না / Invalid status transition: Cannot change from ${d} to ${a}`);if(a==="confirmed"&&!B("confirm_sales"))throw new Error("বুকিং নিশ্চিত করার অনুমতি নেই / No permission to confirm bookings");if(a==="confirmed"){if(new Date(t.ticketInfo?.flightDate||"")<=new Date)throw new Error("অতীতের ���্লাইটের জন্য বুকিং নিশ্চিত করা যাবে না / Cannot confirm booking for past flights");const b=t.sellingPrice*t.passengerInfo.paxCount;if(b>5e5&&!window.confirm(`বড় পরিমাণের বুকিং নিশ্চিতকরণ: ৳${b.toLocaleString()}

আপনি কি ���িশ্চিত?

Large booking confirmation: ৳${b.toLocaleString()}

Are you sure?`))return}if(a==="cancelled"&&!window.confirm(`বুকিং বাতিল করা হবে: ${t.passengerInfo?.name}

আপনি কি নিশ্চিত?

Cancel booking for: ${t.passengerInfo?.name}

Are you sure?`))return;console.log("=== বুকিং স্ট্যাটাস আ���ডেট অডিট লগ / BOOKING STATUS UPDATE AUDIT LOG ==="),console.log("বুকিং আইডি / Booking ID:",s),console.log("যাত্রীর নাম / Passenger Name:",t.passengerInfo?.name),console.log("পূর্বের স্ট্যাটাস / Previous Status:",d),console.log("নতুন স্ট্যাটাস / New Status:",a),console.log("ব্যবহারকারী / User:",h?.name),console.log("সময় / Time:",new Date().toLocaleString()),console.log("=== লগ শেষ / END LOG ==="),await U.updateBookingStatus(s,a),await f(),E({title:"সফল / Success!",description:`বুকিং স্ট্যাটাস আপডেট হয়েছে: ${d} → ${a} / Booking status updated: ${d} → ${a}`})}catch(t){console.error("Failed to update booking status:",t),E({title:"ত্রুটি / Error",description:t.message||"বুকিং স্ট্���াটাস আপডেট করতে ব্যর্থ / Failed to update booking status",variant:"destructive"})}},N=(Array.isArray(r)?r:[]).filter(s=>{const a=s.passengerInfo?.name?.toLowerCase().includes(m.toLowerCase())||s.agentInfo?.name?.toLowerCase().includes(m.toLowerCase())||s.id?.toLowerCase().includes(m.toLowerCase()),t=g==="all"||s.status===g;return a&&t});if(!h)return e.jsx("div",{children:"Loading..."});if(q)return e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(v,{className:"h-6 w-6 animate-spin text-primary"}),e.jsx("span",{className:"font-body text-foreground",children:"Loading bookings..."})]})});if(P||L){const s=L||P,a=s?.includes("Failed to fetch")||s?.includes("Network error")||s?.includes("Unable to connect");return e.jsxs("div",{className:"text-center py-12",children:[e.jsx("div",{className:"mx-auto mb-4 p-3 bg-red-100 rounded-full w-fit",children:a?e.jsx(z,{className:"h-8 w-8 text-red-600"}):e.jsx(j,{className:"h-8 w-8 text-red-600"})}),e.jsx("h3",{className:"text-lg font-heading font-bold text-foreground mb-2",children:a?"Connection Problem":"Error Loading Bookings"}),e.jsx("p",{className:"text-foreground/70 font-body mb-4",children:s}),a&&e.jsxs("div",{className:"text-sm text-muted-foreground mb-6 p-4 bg-muted rounded-lg max-w-md mx-auto",children:[e.jsx("p",{className:"font-medium mb-2",children:"Troubleshooting tips:"}),e.jsxs("ul",{className:"text-left space-y-1",children:[e.jsx("li",{children:"• Check your internet connection"}),e.jsx("li",{children:"• Refresh the page"}),e.jsx("li",{children:"• Try again in a few moments"})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 justify-center",children:[e.jsxs(l,{onClick:()=>{I(),p(null),f()},className:"velvet-button text-primary-foreground font-body",children:[e.jsx(v,{className:"h-4 w-4 mr-2"}),"Try Again"]}),a&&e.jsx(l,{variant:"outline",onClick:()=>window.location.reload(),className:"font-body",children:"Refresh Page"})]})]})}return e.jsxs("div",{className:"space-y-6",children:[e.jsx(u.div,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{duration:.5},children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center space-x-4",children:[e.jsx("div",{className:"p-3 bg-gradient-to-br from-luxury-gold to-luxury-bronze rounded-full animate-glow animate-float",children:e.jsx(w,{className:"h-6 w-6 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-heading font-bold velvet-text",children:"Booking Management"}),e.jsx("p",{className:"text-foreground/70 font-body",children:"Process customer bookings and requests"})]})]}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsxs(l,{onClick:f,variant:"outline",size:"sm",className:"font-body hover:scale-105 transform transition-all duration-200",children:[e.jsx(v,{className:"h-4 w-4 mr-2"}),"Refresh"]}),e.jsxs(l,{variant:"outline",size:"sm",className:"font-body hover:scale-105 transform transition-all duration-200",children:[e.jsx(W,{className:"h-4 w-4 mr-2"}),"Export"]})]})]})}),e.jsx(u.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2,duration:.5},children:e.jsx("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4",children:[{title:"Total Bookings",value:Array.isArray(r)?r.length:0,icon:e.jsx(w,{className:"h-4 w-4 text-white"}),color:"bg-blue-500"},{title:"Pending",value:Array.isArray(r)?r.filter(s=>s.status==="pending").length:0,icon:e.jsx(H,{className:"h-4 w-4 text-white"}),color:"bg-yellow-500"},{title:"Confirmed",value:Array.isArray(r)?r.filter(s=>s.status==="confirmed").length:0,icon:e.jsx(A,{className:"h-4 w-4 text-white"}),color:"bg-green-500"},{title:"Cancelled",value:Array.isArray(r)?r.filter(s=>s.status==="cancelled").length:0,icon:e.jsx(j,{className:"h-4 w-4 text-white"}),color:"bg-red-500"}].map((s,a)=>e.jsx(C,{className:"luxury-card border-0",children:e.jsxs(k,{className:"flex items-center justify-between p-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-foreground/70 font-body",children:s.title}),e.jsx("p",{className:"text-2xl font-bold font-heading velvet-text",children:s.value})]}),e.jsx("div",{className:`p-3 rounded-full ${s.color}`,children:s.icon})]})},s.title))})}),e.jsx(u.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3,duration:.5},children:e.jsx(C,{className:"luxury-card border-0",children:e.jsx(k,{className:"p-6",children:e.jsxs("div",{className:"flex flex-col sm:flex-row gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsxs("div",{className:"relative",children:[e.jsx(K,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-foreground/50 h-4 w-4"}),e.jsx(se,{placeholder:"Search by passenger name, agent, or booking ID...",value:m,onChange:s=>O(s.target.value),className:"pl-10 font-body"})]})}),e.jsxs(ae,{value:g,onValueChange:_,children:[e.jsxs(ne,{className:"w-full sm:w-48 font-body",children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),e.jsx(te,{placeholder:"Filter by status"})]}),e.jsxs(re,{children:[e.jsx(x,{value:"all",children:"All Status"}),e.jsx(x,{value:"pending",children:"Pending"}),e.jsx(x,{value:"confirmed",children:"Confirmed"}),e.jsx(x,{value:"cancelled",children:"Cancelled"}),e.jsx(x,{value:"locked",children:"Locked"})]})]})]})})})}),e.jsx(u.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4,duration:.5},children:e.jsxs(C,{className:"luxury-card border-0",children:[e.jsxs(oe,{children:[e.jsxs(le,{className:"font-heading velvet-text",children:["Booking Requests (",N.length,")"]}),e.jsx(ie,{className:"font-body",children:"Manage and process customer booking requests"})]}),e.jsx(k,{children:e.jsxs("div",{className:"overflow-x-auto",children:[e.jsxs(ce,{children:[e.jsx(de,{children:e.jsxs(F,{children:[e.jsx(i,{className:"font-heading",children:"Booking ID"}),e.jsx(i,{className:"font-heading",children:"Passenger"}),e.jsx(i,{className:"font-heading",children:"Agent"}),e.jsx(i,{className:"font-heading",children:"Status"}),e.jsx(i,{className:"font-heading",children:"Payment"}),e.jsx(i,{className:"font-heading",children:"Created"}),e.jsx(i,{className:"font-heading",children:"Actions"})]})}),e.jsx(me,{children:N.map(s=>e.jsxs(F,{className:"hover:bg-cream-50/50",children:[e.jsxs(c,{className:"font-mono text-xs",children:[s.id.slice(0,8),"..."]}),e.jsx(c,{children:e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(X,{className:"h-4 w-4 text-foreground/50"}),e.jsxs("div",{children:[e.jsx("div",{className:"font-medium font-body",children:s.customer_name}),e.jsx("div",{className:"text-xs text-foreground/50 font-body",children:s.passport_number||"N/A"})]})]})}),e.jsxs(c,{children:[e.jsx("div",{className:"font-body",children:s.agent_name}),e.jsx("div",{className:"text-xs text-foreground/50 font-body",children:s.customer_phone})]}),e.jsx(c,{children:e.jsxs(R,{className:`${pe[s.status]} flex items-center space-x-1 font-body`,children:[Ne[s.status],e.jsx("span",{className:"capitalize",children:s.status})]})}),e.jsx(c,{children:e.jsx(R,{className:`${ye[s.amount_paid>=s.total_amount?"full":"partial"]} font-body`,children:s.amount_paid>=s.total_amount?"Full Payment":"Partial Payment"})}),e.jsx(c,{className:"text-sm text-foreground/70 font-body",children:new Date(s.created_at).toLocaleDateString()}),e.jsx(c,{children:e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs(xe,{children:[e.jsx(he,{asChild:!0,children:e.jsx(l,{variant:"ghost",size:"sm",onClick:()=>G(s),className:"font-body",children:e.jsx(Y,{className:"h-4 w-4"})})}),e.jsxs(ge,{className:"max-w-2xl",children:[e.jsxs(fe,{children:[e.jsx(ue,{className:"font-heading",children:"Booking Details"}),e.jsx(je,{className:"font-body",children:"Complete booking information and actions"})]}),n&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-heading font-semibold",children:"Passenger Information"}),e.jsxs("div",{className:"text-sm space-y-1 font-body",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Name:"})," ",n.customer_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Passport:"})," ",n.passport_number||"N/A"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Phone:"})," ",n.customer_phone]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",n.customer_email]})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-heading font-semibold",children:"Agent Information"}),e.jsxs("div",{className:"text-sm space-y-1 font-body",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Name:"})," ",n.agent_name]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Phone:"})," ",n.agent_phone||n.customer_phone]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Email:"})," ",n.agent_email||n.customer_email]})]})]})]}),e.jsxs("div",{className:"flex space-x-2",children:[B("confirm_bookings")&&n.status==="pending"&&e.jsxs(l,{onClick:()=>$(n.id,"confirmed"),className:"velvet-button bg-green-600 hover:bg-green-700 font-body",children:[e.jsx(A,{className:"h-4 w-4 mr-2"}),"Confirm Booking"]}),n.status!=="cancelled"&&e.jsxs(l,{onClick:()=>$(n.id,"cancelled"),variant:"destructive",className:"font-body",children:[e.jsx(j,{className:"h-4 w-4 mr-2"}),"Cancel Booking"]})]})]})]})]})})})]},s.id))})]}),N.length===0&&e.jsxs("div",{className:"text-center py-12",children:[e.jsx(w,{className:"h-12 w-12 text-foreground/30 mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-heading font-bold text-green-600 mb-2",children:"Database Clean - Ready for Real Bookings!"}),e.jsx("p",{className:"text-foreground/70 font-body",children:m||g!=="all"?"Try adjusting your search or filter criteria.":"All demo bookings have been removed. New bookings will appear here once tickets are added and booked."})]})]})})]})})]})}export{De as B};
